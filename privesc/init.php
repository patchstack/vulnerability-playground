<?php

add_action("wp_ajax_update_site_preference", "update_site_preference");

function update_site_preference(){
    if(empty($_POST['key']) || empty($_POST['value'])){
        echo 'Unable to update key.';
        die();
    }

    update_option($_POST['key'],$_POST['value']);
    echo "site preference updated";
    die();
}

add_action("wp_ajax_change_user_bio", "change_user_bio");

function change_user_bio(){
    $user_id = get_current_user_id();
    $bio_key = $_POST["key"];
    $bio_value = $_POST["value"];

    update_user_meta($user_id, $bio_key, $bio_value);
    echo "bio updated";
}

add_action("wp_ajax_nopriv_open_registration", "open_registration");

function open_registration(){
    $user_data = array(
        'user_login'    => !empty( $_POST['reg_name'] ) ? $_POST['reg_name']: "",
        'user_pass'     => !empty( $_POST['reg_password'] ) ? $_POST['reg_password']: "",
        'user_email'    => !empty( $_POST['reg_email'] ) ? $_POST['reg_email']: "",
        'user_url'      => !empty( $_POST['reg_website'] ) ? $_POST['reg_website']: "",
        'first_name'    => !empty( $_POST['reg_fname'] ) ? $_POST['reg_fname']: "",
        'last_name'     => !empty( $_POST['reg_lname'] ) ? $_POST['reg_lname']: "",
        'nickname'      => !empty( $_POST['reg_nickname'] ) ? $_POST['reg_nickname']: "",
        'description' => !empty( $_POST['reg_bio'] ) ? $_POST['reg_bio']  : "",
        'role'        => !empty( $_POST['reg_role'] ) ? $_POST['reg_role']: get_option( 'default_role' ),
    );    

    $register_user = wp_insert_user( $user_data );
    echo "user registration complete";
}

add_action("wp_ajax_custom_update_profile", "custom_update_profile");

function custom_update_profile(){
    $user_data = array();

    foreach($_POST["data"] as $key => $value){
        $user_data[$key] = $value;
    }
    
    $user_data["ID"] = get_current_user_id();

    wp_update_user( $user_data );
    echo "user profile updated";
}

add_action("wp_ajax_reset_your_password", "reset_your_password");

function reset_your_password(){
    $user_id = get_current_user_id();
    wp_set_password($_POST["new_password"], $user_id);
    echo "reset password success";
}

add_action("wp_ajax_nopriv_configure_platform_callback", "configure_platform_callback");
add_action("wp_ajax_nopriv_login_third_party", "login_third_party");

function configure_platform_callback(){
    $user_id = filter_input( INPUT_POST, 'user_id', FILTER_SANITIZE_STRING );
    $fbid  = filter_input( INPUT_POST, 'fbid', FILTER_SANITIZE_STRING );

    update_user_meta($user_id, "fbid", $fbid);
}

function login_third_party(){
    if ( ! isset( $_GET['fb-login'] ) ) {
        return;
    }

    $value = filter_input( INPUT_GET, 'fbid', FILTER_SANITIZE_STRING );
    $user  = get_users(
        [
            'meta_key'    => 'fbid',
            'meta_value'  => $value,
            'number'      => 1,
            'count_total' => false,
        ]
    );

    $id    = $user[0]->ID;

    wp_clear_auth_cookie();
    wp_set_current_user( $id );
    wp_set_auth_cookie( $id );
}


?>